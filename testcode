#include <Servo.h>

//define PINs
const int sensorPIN = A0;
const int servoPIN = 5;

// Servo
Servo myservo; 
int pos = 0;

// PID control
unsigned long lastTime;
double Input, Output, Setpoint;
double errSum, lastErr;
double kp = 1;
double ki;
double kd;

const unsigned long Ts = 20; // 20 ms
unsigned long lastUpdate = 0;


void setup() {
  pinMode(sensorPIN, INPUT);
  myservo.attach(servoPIN);
  Serial.begin(9600);
}

void loop() {
  // read distance
  float raw = analogRead(sensorPIN);
  float voltage = raw * (5.0 / 1023.0);
  float distance = 27.86 * pow(voltage, -1.15);
  Serial.print("Distance in cm: "); 
  Serial.println(distance);
  delay(10);

  // for (pos = 0; pos <= 180; pos += 1) { // goes from 0 degrees to 180 degrees
  //   // in steps of 1 degree
  //   myservo.write(pos);              // tell servo to go to position in variable 'pos'
  //   delay(15);                       // waits 15ms for the servo to reach the position
  // }
  // for (pos = 180; pos >= 0; pos -= 1) { // goes from 180 degrees to 0 degrees
  //   myservo.write(pos);              // tell servo to go to position in variable 'pos'
  //   delay(15);                       // waits 15ms for the servo to reach the position
  // }

  Setpoint = 15; //distance from sensor to center point [in cm]
  Input = distance;
  /*How long since we last calculated*/
  unsigned long now = millis();
  double dt = (double)(now - lastTime);
  
  /*Compute all the working error variables*/
  double error = Setpoint - Input;
  errSum += (error * dt);
  double dErr = (error -  lastErr) / dt;
  
  /*Compute PID Output*/
  Output = kp * error + ki * errSum + kd * dErr;
  Serial.println(Output);
  pos += Output;
  if (millis() - lastUpdate >= Ts) {
    lastUpdate += Ts;

    // float error = setpoint - measured;
    // float control = pid.update(error);

    int angle = constrain(Output, 0, 180);
    myservo.write(angle);
  }

  /*Remember some variables for next time*/
  lastErr = error;
  lastTime = now;

}